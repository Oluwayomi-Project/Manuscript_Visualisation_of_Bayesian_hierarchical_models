---
title: "BRMS and JAGS Model estimates"
author: "Oluwayomi Akinfenwa"
date: "20/01/2024"
output:
  html_document:
    toc: yes
    toc_depth: '4'
    df_print: paged
  bookdown::html_document2:
    toc: no
    toc_float: yes
    toc_depth: 4
    number_sections: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.duplicate.label = 'allow')
```

### Loading necessary packages

```{r, libraries, include = FALSE}
library(stringr)
library(tidybayes)
library(ggplot2)
library(dplyr)
library(tidyr)
library(rjags)
library(R2jags)
library(bayesplot)
library(patchwork)
library(ggragged)
#library(geofacet)
```

Loading the PISA data for the European countries - Europe_Pisamaths.Rdata.

```{r loading the data}
load(here::here("Saved_PISA_Data", "Europe_Pisamaths.Rdata"))

# We have decided to remove year 2022 from my data and make prediction for 2022.
# Hence i will filter year = 2022.

# rename sigma as se_y
PISA_Europe_Data <- Pisa_Europe_Data |>
  filter(year != "2022") |>
  rename(se_y = sigma)
```

### Creating the grid for the prediction

```{r}
country_names <- levels(factor(PISA_Europe_Data$Country))
region_names <- levels(factor(PISA_Europe_Data$Region))
income_names <- levels(factor(PISA_Europe_Data$Income))
incomeregion_names <- levels(factor(PISA_Europe_Data$Income_Region))

## Obtaining the index for the data
mu_index <- 1:nrow(PISA_Europe_Data)

## Obtaining the region indexes

country_region <- PISA_Europe_Data |> group_by(Country) |>
  summarise(Region=first(Region)) |>
  mutate(Country_num = as.numeric(as.factor(Country))) |>
  mutate(region_num = as.numeric(as.factor(Region)))

REGION <- country_region |> select(Country, Region)

## Obtaining the income indexes

country_income <- PISA_Europe_Data |> group_by(Country) |>
  summarise(Income=first(Income)) |>
  mutate(Country_num = as.numeric(as.factor(Country))) |>
  mutate(income_num = as.numeric(as.factor(Income)))
         
INCOME <- country_income |> select(Country, Income)

## Obtaining the income_region indexes

country_incomeregion <- PISA_Europe_Data |> group_by(Country) |>
  summarise(Income_Region=first(Income_Region)) |>
  mutate(Country_num = as.numeric(as.factor(Country))) |>
  mutate(incomeregion_num = as.numeric(as.factor(Income_Region)))

INCOME_REGION <- REGION |>
  left_join(INCOME, join_by(Country))
         

pred_grid <- PISA_Europe_Data |> 
  modelr::data_grid(Country, year_orig) |>
  mutate(Country_num = as.numeric(as.factor(Country)),
  Region = country_region$Region[Country_num],
  Income = country_income$Income[Country_num],
  Income_Region = country_incomeregion$Income_Region[Country_num]) |>
  mutate(region_num = as.numeric(as.factor(Region)),
         income_num = as.numeric(as.factor(Income)),
         incomeregion_num = as.numeric(as.factor(Income_Region)))

Country_region <- country_region |> left_join(INCOME, join_by(Country))
Country_income <- country_income |> left_join(REGION, join_by(Country))
Country_incomeregion <- country_incomeregion |> 
  left_join(INCOME_REGION, join_by(Country))
```


## Loading the hierarchical models from the saved R.Data file

```{r}
## JAGS Version
#Independent-Country specific model
load(here::here("Manuscript_Models", "Ind_Country_Model.Rdata"))

#Country specific model
load(here::here("Manuscript_Models", "Country_Model.Rdata"))

#Region hierarchical model
load(here::here("Manuscript_Models", "Region_Model.Rdata"))

#Income hierarchical model
load(here::here("Manuscript_Models", "Income_Model.Rdata"))

#Income-Region hierarchical model
load(here::here("Manuscript_Models", "IncomeRegion_Model.Rdata"))

## BRMS Version
#Independent-Country specific model
load(here::here("Manuscript_Models", "CountryInd_BRMSModel.Rdata"))

#Country specific model
load(here::here("Manuscript_Models", "Country_BRMSModel.Rdata"))

#Region hierarchical model
load(here::here("Manuscript_Models", "Region_BRMSModel.Rdata"))

#Income hierarchical model
load(here::here("Manuscript_Models", "Income_BRMSModel.Rdata"))

#Income-Region hierarchical model
load(here::here("Manuscript_Models", "IncomeRegion_BRMSModel.Rdata"))
```

### RESULTS

#### JAGS RESULTS

#### Estimates from the independent-country-specific model

```{r}
Ind_Country_ModelSample <- Ind_C_Model$BUGSoutput$sims.matrix

Ind_CountryI <- spread_rvars(Ind_Country_ModelSample , alpha.j[Country_index]) |>
  mutate(Country = country_names[Country_index], term="Intercept") |>
  left_join(Country_region, join_by(Country== Country))|>
  select(Country,Region,Income, term,rvar=alpha.j)

Ind_CountryS <- spread_rvars(Ind_Country_ModelSample , beta.j[Country_index]) |>
  mutate(Country = country_names[Country_index], term="year_orig") |>
  left_join(Country_region, join_by(Country== Country))|>
  select(Country,Region,Income, term,rvar=beta.j)

## Tidying the estimates
Ind_CountryIS <- rbind(Ind_CountryI, Ind_CountryS)

Ind_CountryIS_Est <- Ind_CountryIS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)


## Credible interval
## Intercept Estimates
Ind_Country_Int_Est <- Ind_CountryI |> median_qi(rvar) |>
  mutate(Model = "Ind_Country \n Model")|>
  select(c(Country,Region,Model, rvar, .lower, .upper))

# Slope Estimates
Ind_Country_Slop_Est <- Ind_CountryS |> median_qi(rvar) |>
  mutate(Model = "Ind_Country \n Model")|>
  select(c(Country,Region, Model, rvar, .lower, .upper))
```

#### Estimates from the country-specific model

```{r}
Country_ModelSample <- C_Model$BUGSoutput$sims.matrix

CountryI <- spread_rvars(Country_ModelSample , alpha.j[Country_index]) |>
  mutate(Country = country_names[Country_index], term="Intercept") |>
  left_join(Country_region, join_by(Country== Country))|>
  select(Country,Region,Income, term,rvar=alpha.j)


CountryS <- spread_rvars(Country_ModelSample , beta.j[Country_index]) |>
  mutate(Country = country_names[Country_index], term="year_orig") |>
  left_join(Country_region, join_by(Country== Country))|>
  select(Country,Region,Income, term,rvar=beta.j)

CountryIS <- rbind(CountryI, CountryS)


Country_IS_Est <- CountryIS |> mutate(coef=median(rvar))|> 
  select(-rvar, Country)|>
  pivot_wider(values_from=coef, names_from=term)

## Credible interval
## Intercept Estimates
Country_Int_Est <- CountryI |> median_qi(rvar) |>
  mutate(Model = "Country \n Model")|>
  select(c(Country,Region, Model,rvar, .lower, .upper))
## Slope Estimates
Country_Slop_Est <- CountryS |> median_qi(rvar) |>
  mutate(Model = "Country \n Model")|>
  select(c(Country,Region, Model,rvar, .lower, .upper))
```

### Estimates from the region hierarchical model

```{r}
Region_ModelSamples <- Region_Model$BUGSoutput$sims.matrix
# get_variables(Region_ModelSamples)

## Hierarchical estimates
Region_I <- spread_rvars(Region_ModelSamples , mu_alpha.r[region_num]) |>
  mutate(Region = region_names[region_num], term = "Intercept") |>
  right_join(Country_region, by = join_by(Region==Region))|>
  rename(rvar =mu_alpha.r) |>
  select(Country,Region, term,rvar)

Region_S <- spread_rvars(Region_ModelSamples , mu_beta.r[region_num]) |>
  mutate(Region = region_names[region_num], term = "year_orig") |>
  right_join(Country_region, by = join_by(Region==Region))|>
  rename(rvar =mu_beta.r) |>
  select(Country,Region, term,rvar)

Region_IS <- rbind(Region_I, Region_S)

## The region country estimates
Rcountry_I <- spread_rvars(Region_ModelSamples , alpha.j[country_num]) |>
  mutate(Country = country_names[country_num], term = "Intercept") |>
  right_join(Country_region, by = join_by(Country==Country))|>
  rename(rvar =alpha.j,Country = Country) |>
  select(Country, Region,Income, term,rvar)


Rcountry_S <- spread_rvars(Region_ModelSamples , beta.j[country_num]) |>
  mutate(Country = country_names[country_num], term = "year_orig") |>
  right_join(Country_region, by = join_by(Country==Country))|>
  rename(rvar =beta.j,Country = Country) |>
  select(Country, Region,Income, term,rvar)

Rcountry_IS <- rbind(Rcountry_I, Rcountry_S) 
```

### Tidying the estimates from the Region hierarchical model

```{r, fig.width=10, fig.height=8}
#median estimates
Region_IS_Est <- Region_IS |> mutate(coef=median(rvar))|> 
  pivot_wider(values_from=coef, names_from=term)

Rcountry_IS_Est <- Rcountry_IS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)

## Credible interval
## Intercept Estimates
#Hierarchy estimates
Region_int_est <- Region_I |> median_qi(rvar) |>
  mutate(Model = "Region \n Model")|>
  select(c(Country,Region, Model,rvar, .lower ,.upper))

#Country estimates
Region_Int_Est <- Rcountry_I |> median_qi(rvar) |>
  mutate(Model = "Region \n Model")|>
  select(c(Country,Region, Model,rvar, .lower, .upper))

## Slope Estimates
#Hierarchy estimates
Region_slop_est <- Region_S |> median_qi(rvar) |>
  mutate(Model = "Region \n Model")|>
  select(c(Country,Region, Model,rvar, .lower ,.upper))

#Country estimates
Region_Slop_Est <- Rcountry_S |> median_qi(rvar) |>
  mutate(Model = "Region \n Model")|>
  select(c(Country,Region, Model,rvar, .lower, .upper))
```

### Estimates from the income hierarchical model

```{r}
Income_ModelSamples <- Income_Model$BUGSoutput$sims.matrix
# get_variables(Income_ModelSamples)
Income_I <- spread_rvars(Income_ModelSamples , mu_alpha.I[income_num]) |>
  mutate(Income = income_names[income_num], term = "Intercept") |>
  right_join(Country_income, by = join_by(Income==Income))|>
  rename(rvar =mu_alpha.I) |>
  select(Country,Region, Income, term,rvar)

Income_S <- spread_rvars(Income_ModelSamples , mu_beta.I[income_num]) |>
  mutate(Income = income_names[income_num], term = "year_orig") |>
  right_join(Country_income, by = join_by(Income==Income))|>
  rename(rvar =mu_beta.I) |>
  select(Country,Region, Income, term,rvar)

Income_IS <- rbind(Income_I, Income_S)

## The income country estimates
Icountry_I <- spread_rvars(Income_ModelSamples , alpha.j[country_num]) |>
  mutate(Country = country_names[country_num], term = "Intercept") |>
  right_join(Country_income, by = join_by(Country==Country))|>
  rename(rvar =alpha.j, Country=Country) |>
  select(Country,Region, Income,Region, term,rvar)


Icountry_S <- spread_rvars(Income_ModelSamples , beta.j[country_num]) |>
  mutate(Country = country_names[country_num], term = "year_orig") |>
  right_join(Country_income, by = join_by(Country==Country))|>
  rename(rvar =beta.j,Country=Country) |>
  select(Country,Region, Income,Region, term,rvar)

Icountry_IS <- rbind(Icountry_I, Icountry_S) 
```

#### Tidying the estimates from the model

```{r, fig.width=10, fig.height=8}
INCOME_IS_EST <- Income_IS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)

Income_IS_Est <- Icountry_IS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)

## Credible interval
## Intercept Estimates
#Hierarchy estimates
Income_int_est <- Income_I |> median_qi(rvar) |>
  mutate(Model = "Income \n Model")|>
  select(c(Country,Region, Model,rvar, .lower ,.upper))
#Country estimates
Income_Int_Est <- Icountry_I |> median_qi(rvar) |>
  mutate(Model = "Income \n Model")|>
  select(c(Country,Region, Model,rvar, .lower, .upper))

## Slope Estimates
#Hierarchy estimates
Income_slop_est <- Income_S |> median_qi(rvar) |>
  mutate(Model = "Income \n Model")|>
  select(c(Country,Region, Model,rvar, .lower ,.upper))
#Country estimates
Income_Slop_Est <- Icountry_S |> median_qi(rvar) |>
  mutate(Model = "Income \n Model")|>
  select(c(Country,Region, Model,rvar, .lower, .upper))
```

### Estimates from the incomeregion hierarchical model

```{r}
IR_ModelSamples <- IR_Model$BUGSoutput$sims.matrix
# get_variables(IR_ModelSamples)
IncomeRegion_I <- spread_rvars(IR_ModelSamples , mu_alpha.IR[income_num]) |>
  mutate(Income_Region = incomeregion_names[income_num], term = "Intercept") |>
  right_join(Country_incomeregion, by = join_by(Income_Region ==Income_Region ))|>
  rename(rvar =mu_alpha.IR) |>
  select(Country,Region,Income,Income_Region,term,rvar)

IncomeRegion_S <- spread_rvars(IR_ModelSamples , mu_beta.IR[income_num]) |>
  mutate(Income_Region  = incomeregion_names[income_num], term = "year_orig") |>
  right_join(Country_incomeregion, by = join_by(Income_Region ==Income_Region ))|>
  rename(rvar =mu_beta.IR) |>
  select(Country,Region,Income,Income_Region,term,rvar)

IncomeRegion_IS <- rbind(IncomeRegion_I, IncomeRegion_S)

## The income country estimates
IRcountry_I <- spread_rvars(IR_ModelSamples , alpha.j[country_num]) |>
  mutate(Country = country_names[country_num], term = "Intercept") |>
  right_join(Country_incomeregion, by = join_by(Country==Country))|>
  rename(rvar =alpha.j, Country=Country) |>
  select(Country,Region, Income, Income_Region, term,rvar)


IRcountry_S <- spread_rvars(IR_ModelSamples , beta.j[country_num]) |>
  mutate(Country = country_names[country_num], term = "year_orig") |>
  right_join(Country_incomeregion, by = join_by(Country==Country))|>
  rename(rvar =beta.j,Country=Country) |>
  select(Country,Region,Income, Income_Region, term,rvar)

IRcountry_IS <- rbind(IRcountry_I, IRcountry_S) 
```

#### The median and credible interval estimates for the IncomeRegion model

```{r}
## Median
IR_IS_EST <- IncomeRegion_IS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)

IncomeRegion_IS_Est <- IRcountry_IS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)

## Credible interval
## Intercept Estimates
#Hierarchy estimates
IncomeRegion_int_est <- IncomeRegion_I |> median_qi(rvar) |>
  mutate(Model = "Income-Region \n Model")|>
  select(c(Country,Region,Income, Model,rvar, .lower ,.upper))
#Country estimates
Income_Region_Int_Est <- IRcountry_I |> median_qi(rvar) |>
  mutate(Model = "Income-Region \n Model")|>
  select(c(Country,Region, Income, Model,rvar, .lower, .upper))
## Slope Estimates
#Hierarchy estimates
IncomeRegion_slop_est <- IncomeRegion_S |> median_qi(rvar) |>
  mutate(Model = "Income-Region \n Model")|>
  select(c(Country,Region, Income, Model,rvar, .lower ,.upper))
#Country estimates
Income_Region_Slop_Est <- IRcountry_S |> median_qi(rvar) |>
  mutate(Model = "Income-Region \n Model")|>
  select(c(Country,Region, Income, Model,rvar, .lower, .upper))
```

#### BRMS RESULTS

#### Estimates from the BRMS independent-country-specific model

```{r}
## Pulling the intercept results. The global intercept (b_Intercept) and the country offsets.

Ind_CountrybrmsI <- spread_rvars(CountryInd_BRMSModel, r_Country[Country,term], b_Intercept) |>
  filter(term == "Intercept") |>
  mutate(Country = stringr::str_replace_all(Country, fixed("."), " ")) |>
  mutate(r_Country = r_Country+ b_Intercept) |>
  left_join(Country_region, join_by(Country== Country))|>
  select(Country,Region, Income, term, rvar=r_Country)

## Pulling the slope results. The global slope (b_year_orig) as the slope estimates for all the countries
Ind_CountrybrmsS <- spread_rvars(CountryInd_BRMSModel, r_Country[Country,term], b_year_orig) |> filter(term == "year_orig") |>
  mutate(Country = stringr::str_replace_all(Country, fixed("."), " "))  |>
  mutate(r_Country = r_Country+ b_year_orig) |>
  left_join(Country_region, join_by(Country== Country))|>
  select(Country,Region, Income, term, rvar= r_Country)

## Tidying the estimates
Ind_CountrybrmsIS <- rbind(Ind_CountrybrmsI, Ind_CountrybrmsS)

IndCountry_brmsIS_Est <- Ind_CountrybrmsIS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)


## Credible interval
## Intercept Estimates
Ind_Country_brmsInt_Est <- Ind_CountrybrmsI |> median_qi(rvar) |>
   mutate(Model = "Ind_Country \n Model")|>
  select(c(Country,Region, Model,rvar, .lower, .upper))

## Slope Estimates
Ind_Country_brmsSlop_Est <- Ind_CountrybrmsS |> median_qi(rvar) |>
   mutate(Model = "Ind_Country \n Model")|>
  select(c(Country,Region, Model,rvar, .lower, .upper))
```

#### Estimates from the BRMS country-specific model

```{r}
## Pulling the intercept results. The global intercept (b_Intercept) and the country offsets.
Country_brmsI <- spread_rvars(Country_BRMSModel, r_Country[Country,term], b_Intercept) |>
  filter(term == "Intercept") |>
  mutate(Country = stringr::str_replace_all(Country, fixed("."), " ")) |>
  mutate(r_Country = r_Country+ b_Intercept) |>
  left_join(Country_region, join_by(Country== Country))|>
  select(Country,Region, Income, term, rvar=r_Country)

## Pulling the slope results. The global slope (b_year_orig) and the country offsets.
Country_brmsS <- spread_rvars(Country_BRMSModel, r_Country[Country,term], b_year_orig) |>
  filter(term == "year_orig") |>
  mutate(Country = stringr::str_replace_all(Country, fixed("."), " ")) |>
  mutate(r_Country = r_Country+ b_year_orig) |>
  left_join(Country_region, join_by(Country== Country))|>
  select(Country,Region, Income, term, rvar=r_Country)

## Tidying the estimates
Country_brmsIS <- rbind(Country_brmsI, Country_brmsS)

Country_brmsIS_Est <- Country_brmsIS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)

## Credible interval
## Intercept Estimates
Country_brmsInt_Est <- Country_brmsI |> median_qi(rvar) |>
  mutate(Model = "Country \n Model")|>
  select(c(Country,Region, Model,rvar, .lower, .upper))

## Slope Estimates
Country_brmsSlop_Est <- Country_brmsS |> median_qi(rvar) |>
  mutate(Model = "Country \n Model")|>
  select(c(Country,Region, Model,rvar, .lower, .upper))
```

#### Estimates from the BRMS Region hierarchical model

```{r}
Region_brmsI <- spread_rvars(Region_BRMSModel, r_Region[group1,term],b_Intercept) |>
  filter(term == "Intercept") |>
  mutate(group1 = stringr::str_replace_all(group1, fixed("."), " ")) |>
  mutate(r_Region = r_Region+ b_Intercept) |>
  rename(rvar=r_Region, Region = group1) |>
   right_join(Country_region, by = join_by(Region==Region))|>
  select(Country,Region, term, rvar)

Region_brmsS <- spread_rvars(Region_BRMSModel, r_Region[group1,term], b_year_orig) |>
  filter(term == "year_orig") |>
  mutate(group1 = stringr::str_replace_all(group1, fixed("."), " ")) |>
  mutate(r_Region = r_Region+  b_year_orig) |>
  rename(rvar=r_Region, Region = group1)|>
  right_join(Country_region, by = join_by(Region==Region))|>
  select(Country,Region, term, rvar)


Region_brmsIS <- rbind(Region_brmsI,Region_brmsS) 

## The region country estimates
Rcountry_brmsI <- spread_rvars(Region_BRMSModel, r_Region[group1,term],r_Country[group,term],b_Intercept) |>
  filter(term == "Intercept") |>
  mutate(group1 = stringr::str_replace_all(group1, fixed("."), " "), 
         group = stringr::str_replace_all(group, fixed("."), " ")) |>
  right_join(Country_region, by = join_by(group==Country,group1==Region)) |> #this join everything from the country_region with its intercession from the model result
  mutate(r_Country =  r_Country+ r_Region+ b_Intercept) |>
  rename(rvar=r_Country,Region=group1, Country =group) |>
  select(Country,Region, Income, term, rvar)



Rcountry_brmsS <- spread_rvars(Region_BRMSModel, r_Region[group1,term],r_Country[group,term],b_year_orig) |>
  filter(term == "year_orig") |>
  mutate(group1 = stringr::str_replace_all(group1, fixed("."), " "), 
         group = stringr::str_replace_all(group, fixed("."), " ")) |>
  right_join(Country_region, by = join_by(group==Country,group1==Region)) |>
  mutate(r_Country =  r_Country+ r_Region+ b_year_orig) |>
  rename(rvar=r_Country,Region=group1, Country =group) |>
  select(Country,Region, Income, term, rvar)

Rcountry_brmsIS <- rbind(Rcountry_brmsI, Rcountry_brmsS)
```

### Tidying the estimates from the BRMS Region hierarchical model

```{r}
#median estimates
Region_brmsIS_Est <- Region_brmsIS |> mutate(coef=median(rvar))|>
  pivot_wider(values_from=coef, names_from=term)

Rcountry_brmsIS_Est <- Rcountry_brmsIS |> mutate(coef=median(rvar))|> 
  pivot_wider(values_from=coef, names_from=term)

## Credible interval
## Intercept Estimates
#Hierarchy estimates
Region_brmsInt_est <- Region_brmsI |> median_qi(rvar) |>
  mutate(Model = "Region \n Model")|>
  select(c(Country,Region, Model,rvar, .lower ,.upper))

#Country estimates
Region_brmsInt_Est <- Rcountry_brmsI |> median_qi(rvar) |>
  mutate(Model = "Region \n Model")|>
  select(c(Country,Region, Model,rvar, .lower, .upper))

## Slope Estimates
#Hierarchy estimates
Region_brmsSlop_est <- Region_brmsS |> median_qi(rvar) |>
  mutate(Model = "Region \n Model")|>
  select(c(Country,Region, Model,rvar, .lower ,.upper))

#Country estimates
Region_brmsSlop_Est <- Rcountry_brmsS |> median_qi(rvar) |>
  mutate(Model = "Region \n Model")|>
  select(c(Country,Region, Model,rvar, .lower, .upper))
```

#### Estimates from the BRMS income hierarchical model

```{r}
Income_brmsI <- spread_rvars(Income_BRMSModel, r_Income[group1,term],b_Intercept) |>
  filter(term == "Intercept") |>
  mutate(group1 = stringr::str_replace_all(group1, fixed("."), " ")) |>
  mutate(r_Income = r_Income+ b_Intercept) |>
  rename(Income = group1, rvar=r_Income) |>
  right_join(Country_income, by = join_by(Income==Income))|>
  select(Country,Region, Income, term,rvar)

Income_brmsS <- spread_rvars(Income_BRMSModel, r_Income[group1,term], b_year_orig) |>
  filter(term == "year_orig") |>
  mutate(group1 = stringr::str_replace_all(group1, fixed("."), " ")) |>
  mutate(r_Income = r_Income+  b_year_orig) |>
  rename(Income = group1, rvar=r_Income) |>
  right_join(Country_income, by = join_by(Income==Income))|>
  select(Country,Region, Income, term,rvar)


Income_brmsIS <- rbind(Income_brmsI, Income_brmsS)
```

pulling the intercepts and slopes for each country based on the influence of the Income hierarchy

```{r}
Icountry_brmsI <- spread_rvars(Income_BRMSModel, r_Income[group1,term],r_Country[group,term],b_Intercept) |>
  filter(term == "Intercept") |>
  mutate(group1 = stringr::str_replace_all(group1, fixed("."), " "), 
         group = stringr::str_replace_all(group, fixed("."), " ")) |>
  right_join(Country_income, by = join_by(group==Country,group1==Income)) |> #this join everything from the country_Income with its intercession from the model result
  mutate(r_Country =  r_Country+ r_Income+ b_Intercept) |>
  rename(rvar=r_Country, Country = group, Income = group1) |>
  select(Country, Income,Region, term, rvar)


Icountry_brmsS <- spread_rvars(Income_BRMSModel, r_Income[group1,term],r_Country[group,term],b_year_orig) |>
  filter(term == "year_orig") |>
  mutate(group1 = stringr::str_replace_all(group1, fixed("."), " "), 
         group = stringr::str_replace_all(group, fixed("."), " ")) |>
  right_join(Country_income, by = join_by(group==Country,group1==Income)) |>
  mutate(r_Country =  r_Country+ r_Income+ b_year_orig) |>
  rename(rvar=r_Country, Country = group, Income = group1) |>
  select(Country, Income, Region, term, rvar)

Icountry_brmsIS <- rbind(Icountry_brmsI, Icountry_brmsS) 
```

#### Tidying the estimates from the BRMS income model

```{r, fig.width=10, fig.height=8}
INCOME_BRMS_IS_EST <- Income_brmsIS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)

Income_BRMS_IS_Est <- Icountry_brmsIS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)

## Credible interval
## Intercept Estimates
#Hierarchy estimates
Income_brmsInt_est <- Income_brmsI |> median_qi(rvar) |>
  mutate(Model = "Income \n Model")|>
  select(c(Country,Region, Model,rvar, .lower ,.upper))
#Country estimates
Income_brmsInt_Est <- Icountry_brmsI |> median_qi(rvar) |>
  mutate(Model = "Income \n Model")|>
  select(c(Country,Region, Model,rvar, .lower, .upper))

## Slope Estimates
#Hierarchy estimates
Income_brmsSlop_est <- Income_brmsS |> median_qi(rvar) |>
  mutate(Model = "Income \n Model")|>
  select(c(Country,Region, Model,rvar, .lower ,.upper))
#Country estimates
Income_brmsSlop_Est <- Icountry_brmsS |> median_qi(rvar) |>
  mutate(Model = "Income \n Model")|>
  select(c(Country,Region, Model,rvar, .lower, .upper))
```

#### Estimates from the BRMS IncomeRegion hierarchical model

```{r}
IncomeRegion_brmsI <- spread_rvars(IncomeRegion_BRMSModel, r_Income_Region[group1,term],b_Intercept) |>
  filter(term == "Intercept") |>
  mutate(group1 = stringr::str_replace_all(group1, fixed("."), " ")) |>
  mutate(r_Income_Region = r_Income_Region+ b_Intercept) |>
  rename(rvar=r_Income_Region, `Income_Region` = group1) |>
  right_join(Country_incomeregion, by = join_by(Income_Region ==Income_Region ))|>
  select(Country,Region,Income,Income_Region,term,rvar)

IncomeRegion_brmsS <- spread_rvars(IncomeRegion_BRMSModel, r_Income_Region[group1,term], b_year_orig) |>
  filter(term == "year_orig") |>
  mutate(group1 = stringr::str_replace_all(group1, fixed("."), " ")) |>
  mutate(r_Income_Region = r_Income_Region+  b_year_orig) |>
  rename(rvar=r_Income_Region, `Income_Region` = group1) |>
  right_join(Country_incomeregion, by = join_by(Income_Region ==Income_Region ))|>
  select(Country,Region,Income,Income_Region,term,rvar)


IncomeRegion_brmsIS <- rbind(IncomeRegion_brmsI, IncomeRegion_brmsS)
```

pulling the intercepts and slopes for each country based on the influence of the Income-Region hierarchy.

```{r}
IRcountry_brmsI <- spread_rvars(IncomeRegion_BRMSModel, r_Income_Region[group1,term],r_Country[group,term],b_Intercept) |>
  filter(term == "Intercept") |>
  mutate(group1 = stringr::str_replace_all(group1, fixed("."), " "), 
         group = stringr::str_replace_all(group, fixed("."), " ")) |>
  right_join(Country_incomeregion, by = join_by(group==Country,group1==Income_Region)) |> #this join everything from the country_Income with its intercession from the model result
  mutate(r_Country =  r_Country+ r_Income_Region+ b_Intercept) |>
  rename(rvar=r_Country, Country = group, Income_Region = group1) |>
  select(Country, Income_Region,Region,Income, term, rvar)


IRcountry_brmsS <- spread_rvars(IncomeRegion_BRMSModel, r_Income_Region[group1,term],r_Country[group,term],b_year_orig) |>
  filter(term == "year_orig") |>
  mutate(group1 = stringr::str_replace_all(group1, fixed("."), " "), 
         group = stringr::str_replace_all(group, fixed("."), " ")) |>
  right_join(Country_incomeregion, by = join_by(group==Country,group1==Income_Region)) |>
  mutate(r_Country =  r_Country+ r_Income_Region+ b_year_orig) |>
  rename(rvar=r_Country, Country = group, Income_Region = group1) |>
  select(Country, Income_Region, Region,Income, term, rvar)

IRcountry_brmsIS <- rbind(IRcountry_brmsI, IRcountry_brmsS) 
```

#### The median and credible interval estimates for the BRMS IncomeRegion model

```{r, fig.width=10, fig.height=8}
IR_BRMS_IS_EST <- IncomeRegion_brmsIS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)

IRC_BRMS_IS_Est <- IRcountry_brmsIS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)

## Credible interval
## Intercept Estimates
#Hierarchy estimates
IncomeRegion_brmsInt_est <- IncomeRegion_brmsI |> median_qi(rvar) |>
  mutate(Model = "Income-Region \n Model")|>
  select(c(Country,Region,Income, Model,rvar, .lower ,.upper))
#Country estimates
Income_Region_brmsInt_Est <- IRcountry_brmsI |> median_qi(rvar) |>
  mutate(Model = "Income-Region \n Model")|>
  select(c(Country,Region, Income, Model,rvar, .lower, .upper))
## Slope Estimates
#Hierarchy estimates
IncomeRegion_brmsSlop_est <- IncomeRegion_brmsS |> median_qi(rvar) |>
  mutate(Model = "Income-Region \n Model")|>
  select(c(Country,Region, Income, Model,rvar, .lower ,.upper))
#Country estimates
Income_Region_brmsSlop_Est <- IRcountry_brmsS |> median_qi(rvar) |>
  mutate(Model = "Income-Region \n Model")|>
  select(c(Country,Region, Income, Model,rvar, .lower, .upper))
```

### Plotting the model fit on the data

#### Independent country model fit on the data

```{r}
if (!dir.exists(here::here("Saved_Plots/Regression_fits")))
  dir.create(here::here("Saved_Plots/Regression_fits"))

Labels <- c("2003", "2006", "2009", "2012", "2015", "2018")
```

#### The plots

```{r}
#Independent Country model fit

#BRMS
pdf("Saved_Plots/Regression_fits/BRMS_ind_country_model_fit.pdf",
    width = 12,
    height = 9)
ggplot(PISA_Europe_Data, aes(x=year_orig, y=math))+ 
  geom_point()+
  facet_wrap(~Country, nrow = 5)+
  geom_abline(data=CountryInd_brmsIS_Est, aes(slope=year_orig, intercept= Intercept), color="black")+
  scale_x_continuous(breaks = c(0, 3,6,9,12,15), labels = Labels)+
  xlab("year")+ ggtitle("BRMS Independent country model fit on the data")+
  theme_bw()+
  theme(panel.spacing=unit(1,"lines"),
        legend.position = "bottom",
        plot.subtitle = element_text(family = "Consolas"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
dev.off()

#JAGS
pdf("Saved_Plots/Regression_fits/JAGS_ind_country_model_fit.pdf",
    width = 12,
    height = 9)
ggplot(PISA_Europe_Data, aes(x=year_orig, y=math))+ 
  geom_point()+
  facet_wrap(~Country, nrow = 5)+
  geom_abline(data= Ind_CountryIS_Est, aes(slope=year_orig, intercept= Intercept), color="green4")+
  scale_x_continuous(breaks = c(0, 3,6,9,12,15), labels = Labels)+
  xlab("year")+ ggtitle("JAGS Independent country model fit on the data")+
  theme_bw()+
  theme(panel.spacing=unit(1,"lines"),
        legend.position = "bottom",
        plot.subtitle = element_text(family = "Consolas"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
dev.off()


#Both BRMS and JAGS fits
pdf("Saved_Plots/Regression_fits/ind_country_model_fit.pdf",
    width = 12,
    height = 9)
ggplot(PISA_Europe_Data, aes(x=year_orig, y=math))+ 
  geom_point()+
  facet_wrap(~Country, nrow = 5)+
  geom_abline(data= Ind_CountryIS_Est, aes(slope=year_orig, intercept= Intercept), color="green4")+
  geom_abline(data=CountryInd_brmsIS_Est, aes(slope=year_orig, intercept= Intercept), color="black")+
  scale_x_continuous(breaks = c(0, 3,6,9,12,15), labels = Labels)+
  xlab("year")+ ggtitle("JAGS and BRMS Independent country model fit on the data \n JAGS in green and BRMS in black")+
  theme_bw()+
  theme(panel.spacing=unit(1,"lines"),
        legend.position = "bottom",
        plot.subtitle = element_text(family = "Consolas"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
dev.off()
```

#### Country model fit on the data

```{r}
#BRMS
pdf("Saved_Plots/Regression_fits/BRMS_country_model_fit.pdf",
    width = 12,
    height = 9)
ggplot(PISA_Europe_Data, aes(x=year_orig, y=math))+ 
  geom_point()+
  facet_wrap(~Country, nrow = 5)+
  geom_abline(data=Country_brmsIS_Est, aes(slope=year_orig, intercept= Intercept), color="magenta3")+
  scale_x_continuous(labels = function(x) {x+2003}, breaks = seq(3,18,3))+
  xlab("year")+ ggtitle("BRMS Country model fit on the data")+
  theme_bw()+
  theme(panel.spacing=unit(1,"lines"),
        legend.position = "bottom",
        plot.subtitle = element_text(family = "Consolas"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
dev.off()

#JAGS
pdf("Saved_Plots/Regression_fits/JAGS_country_model_fit.pdf",
    width = 12,
    height = 9)
ggplot(PISA_Europe_Data, aes(x=year_orig, y=math))+ 
  geom_point()+
  facet_wrap(~Country, nrow = 5)+
  geom_abline(data=Country_IS_Est, aes(slope=year_orig, intercept= Intercept), color="magenta4")+
  scale_x_continuous(breaks = c(0, 3,6,9,12,15), labels = Labels)+
  xlab("year")+ ggtitle("JAGS Country-specific model fit on the data")+
  theme_bw()+
  theme(panel.spacing=unit(1,"lines"),
        legend.position = "bottom",
        plot.subtitle = element_text(family = "Consolas"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
dev.off()

##Both JAGS and BRMS fit on the same plot
pdf("Saved_Plots/Regression_fits/country_model_fit.pdf",
    width = 12,
    height = 9)
ggplot(PISA_Europe_Data, aes(x=year_orig, y=math))+ 
  geom_point()+
  facet_wrap(~Country, nrow = 5)+
  geom_abline(data=Country_IS_Est, aes(slope=year_orig, intercept= Intercept), color="magenta4")+
  geom_abline(data=Country_brmsIS_Est, aes(slope=year_orig, intercept= Intercept), color="grey")+
  scale_x_continuous(breaks = c(0, 3,6,9,12,15), labels = Labels)+
  xlab("year")+ ggtitle("JAGS and BRMS Country-specific model fit on the data \n JAGS in magenta and BRMS in grey")+
  theme_bw()+
  theme(panel.spacing=unit(1,"lines"),
        legend.position = "bottom",
        plot.subtitle = element_text(family = "Consolas"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
dev.off()
```

#### Region model fit on the data

```{r}
#BRMS
pdf("Saved_Plots/Regression_fits/BRMS_region_model.pdf",
    width = 12,
    height = 9)
ggplot(PISA_Europe_Data, aes(x=year_orig, y=math))+ 
  geom_point()+
  ggh4x::facet_nested_wrap(vars(Region, Country), nrow = 5)+
  geom_abline(data= Rcountry_brmsIS_Est, aes(slope=year_orig, intercept= Intercept), color="blue3")+
  scale_x_continuous(labels = function(x) {x+2003}, breaks = seq(3,18,3))+
  xlab("year")+ ggtitle("BRMS Region model fit on the data")+
  theme_bw()+
  theme(panel.spacing=unit(1,"lines"),
        legend.position = "bottom",
        plot.subtitle = element_text(family = "Consolas"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
dev.off()

#JAGS
pdf("Saved_Plots/Regression_fits/JAGS_region_model.pdf",
    width = 12,
    height = 9)
ggplot(PISA_Europe_Data, aes(x=year_orig, y=math))+ 
  geom_point()+
  ggh4x::facet_nested_wrap(vars(Region, Country), nrow = 5)+
  geom_abline(data=Rcountry_IS_Est, aes(slope=year_orig, intercept= Intercept), color="red3")+
  scale_x_continuous(breaks = c(0, 3,6,9,12,15), labels = Labels)+
  xlab("year")+ ggtitle("JAGS Region hierarchical model fit on the data")+
  theme_bw()+
  theme(panel.spacing=unit(1,"lines"),
        legend.position = "bottom",
        plot.subtitle = element_text(family = "Consolas"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
dev.off()

#Both BRMS and JAGS
pdf("Saved_Plots/Regression_fits/region_model.pdf",
    width = 12,
    height = 9)
ggplot(PISA_Europe_Data, aes(x=year_orig, y=math))+ 
  geom_point()+
  ggh4x::facet_nested_wrap(vars(Region, Country), nrow = 5)+
  geom_abline(data=Rcountry_IS_Est, aes(slope=year_orig, intercept= Intercept), color="red4")+
  geom_abline(data= Rcountry_brmsIS_Est, aes(slope=year_orig, intercept= Intercept), color="grey")+
  scale_x_continuous(breaks = c(0, 3,6,9,12,15), labels = Labels)+
  xlab("year")+ ggtitle("Region hierarchical model fit on the data \n BRMS in grey and JAGS in red")+
  theme_bw()+
  theme(panel.spacing=unit(1,"lines"),
        legend.position = "bottom",
        plot.subtitle = element_text(family = "Consolas"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
dev.off()
```

#### Income model fit on the data

```{r}
#BRMS
pdf("Saved_Plots/Regression_fits/BRMS_income_model_fit.pdf",
    width = 12,
    height = 9) 
ggplot(PISA_Europe_Data, aes(x=year_orig, y=math))+ 
  geom_point()+
  ggh4x::facet_nested_wrap(vars(Income, Country), nrow = 5)+
  geom_abline(data=Income_BRMS_IS_Est, aes(slope=year_orig, intercept= Intercept), color="red3")+
  scale_x_continuous(labels = function(x) {x+2003}, breaks = seq(3,18,3))+
  xlab("year")+ ggtitle("BRMS_Income model fit on the data")+
  theme_bw()+
  theme(panel.spacing=unit(1,"lines"),
        legend.position = "bottom",
        plot.subtitle = element_text(family = "Consolas"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
dev.off()

#JAGS
pdf("Saved_Plots/Regression_fits/JAGS_income_model_fit.pdf",
    width = 12,
    height = 9) 
ggplot(PISA_Europe_Data, aes(x=year_orig, y=math))+ 
  geom_point()+
  ggh4x::facet_nested_wrap(vars(Income, Country), nrow = 5)+
  geom_abline(data=Income_IS_Est, aes(slope=year_orig, intercept= Intercept), color="red4")+
  scale_x_continuous(breaks = c(0, 3,6,9,12,15), labels = Labels)+
  xlab("year")+ ggtitle("JAGS Income hierarchical model fit on the data")+
  theme_bw()+
  theme(panel.spacing=unit(1,"lines"),
        legend.position = "bottom",
        plot.subtitle = element_text(family = "Consolas"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
dev.off()

#both BRMS and JAGS fit
pdf("Saved_Plots/Regression_fits/income_model_fit.pdf",
    width = 12,
    height = 9) 
ggplot(PISA_Europe_Data, aes(x=year_orig, y=math))+ 
  geom_point()+
  ggh4x::facet_nested_wrap(vars(Income, Country), nrow = 5)+
  geom_abline(data=Income_IS_Est, aes(slope=year_orig, intercept= Intercept), color="red4")+
  geom_abline(data=Income_BRMS_IS_Est, aes(slope=year_orig, intercept= Intercept), color="grey")+
  scale_x_continuous(breaks = c(0, 3,6,9,12,15), labels = Labels)+
  xlab("year")+ ggtitle("Income hierarchical model fit on the data \n BRMS in grey and JAGS in red")+
  theme_bw()+
  theme(panel.spacing=unit(1,"lines"),
        legend.position = "bottom",
        plot.subtitle = element_text(family = "Consolas"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
dev.off()
```

#### IncomeRegion model fit on the data

```{r}
#BRMS
pdf("Saved_Plots/Regression_fits/BRMS_incomeregion_model_fit.pdf",
    width = 12,
    height = 9)

ggplot(PISA_Europe_Data, aes(x=year_orig, y=math))+ 
  geom_point()+
  ggh4x::facet_nested_wrap(vars(Income_Region, Country), nrow = 5)+
  geom_abline(data=IRC_BRMS_IS_Est, aes(slope=year_orig, intercept= Intercept), color="red3")+
  scale_x_continuous(labels = function(x) {x+2003}, breaks = seq(3,18,3))+
  xlab("year")+ ggtitle("BRMS Income-Region model fit on the data")+
  theme_bw()+
  theme(panel.spacing=unit(1,"lines"),
        legend.position = "bottom",
        plot.subtitle = element_text(family = "Consolas"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
dev.off()

#JAGS
pdf("Saved_Plots/Regression_fits/JAGS_incomeregion_model_fit.pdf",
    width = 12,
    height = 9)
ggplot(PISA_Europe_Data, aes(x=year_orig, y=math))+ 
  geom_point()+
  ggh4x::facet_nested_wrap(vars(Income_Region, Country), nrow = 5)+
  geom_abline(data=IncomeRegion_IS_Est, aes(slope=year_orig, intercept= Intercept), color="brown2")+
  scale_x_continuous(breaks = c(0, 3,6,9,12,15), labels = Labels)+
  xlab("year")+ ggtitle("JAGS Income-Region hierarchical model fit on the data")+
  theme_bw()+
  theme(panel.spacing=unit(1,"lines"),
        legend.position = "bottom",
        plot.subtitle = element_text(family = "Consolas"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
dev.off()

#both BRMS and JAGS fits
pdf("Saved_Plots/Regression_fits/incomeregion_model_fit.pdf",
    width = 12,
    height = 9)
ggplot(PISA_Europe_Data, aes(x=year_orig, y=math))+ 
  geom_point()+
  ggh4x::facet_nested_wrap(vars(Income_Region, Country), nrow = 5)+
  geom_abline(data=IncomeRegion_IS_Est, aes(slope=year_orig, intercept= Intercept), color="brown2")+
    geom_abline(data=IRC_BRMS_IS_Est, aes(slope=year_orig, intercept= Intercept), color="grey")+
  scale_x_continuous(breaks = c(0, 3,6,9,12,15), labels = Labels)+
  xlab("year")+ ggtitle("Income-Region hierarchical model fit on the data \n BRMS in grey and JAGS in red")+
  theme_bw()+
  theme(panel.spacing=unit(1,"lines"),
        legend.position = "bottom",
        plot.subtitle = element_text(family = "Consolas"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
dev.off()
```

### Comparing the model results

#### Intercept

```{r}
if (!dir.exists(here::here("Saved_Plots/Model_fits_Comparison")))
  dir.create(here::here("Saved_Plots/Model_fits_Comparison"))

#Independent model fit
pdf("Saved_Plots/Model_fits_Comparison/Independent_Country_model_Int.pdf",
    width = 12,
    height = 9)
ggplot()+
  geom_point(data = Ind_Country_brmsInt_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "red4")+
  geom_errorbar(data = Ind_Country_brmsInt_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "red4")+
  geom_point(data = Ind_Country_Int_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "blue4",position=position_nudge(y = -0.18))+
  geom_errorbar(data = Ind_Country_Int_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "blue4",position=position_nudge(y = -0.18))+
  ggtitle("Independent linear fit estimates \n JAGS in blue and BRMS in red")+
  labs(x = "Intercept estimates", y = "Country")
dev.off()

#COuntry model fit
pdf("Saved_Plots/Model_fits_Comparison/Country_model_Int.pdf",
    width = 12,
    height = 9)
ggplot()+
  geom_point(data = Country_brmsInt_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "red4")+
  geom_errorbar(data = Country_brmsInt_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "red4")+
  geom_point(data = Country_Int_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "blue4",position=position_nudge(y = -0.18))+
  geom_errorbar(data = Country_Int_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "blue4",position=position_nudge(y = -0.18))+
  ggtitle("Country-specific estimates \n JAGS in blue and BRMS in red")+
  labs(x = "Intercept estimates", y = "Country")
dev.off()

# Region hierarchical model fit
pdf("Saved_Plots/Model_fits_Comparison/Region_model_Int.pdf",
    width = 12,
    height = 9)
ggplot()+
  geom_point(data = Region_brmsInt_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "red4")+
  geom_errorbar(data = Region_brmsInt_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "red4")+
  geom_point(data = Region_Int_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "blue4",position=position_nudge(y = -0.18))+
  geom_errorbar(data = Region_Int_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "blue4",position=position_nudge(y = -0.18))+
  ggtitle("Region hierarchical estimates \n JAGS in blue and BRMS in red")+
  labs(x = "Intercept estimates", y = "Country")
dev.off()

#Income hierarchical model fit
pdf("Saved_Plots/Model_fits_Comparison/Income_model_Int.pdf",
    width = 12,
    height = 9)
ggplot()+
  geom_point(data = Income_brmsInt_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "red4")+
  geom_errorbar(data = Income_brmsInt_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "red4")+
  geom_point(data = Income_Int_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "blue4",position=position_nudge(y = -0.18))+
  geom_errorbar(data = Income_Int_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "blue4",position=position_nudge(y = -0.18))+
  ggtitle("Income hierarchical estimates \n JAGS in blue and BRMS in red")+
  labs(x = "Intercept estimates", y = "Country")
dev.off()


pdf("Saved_Plots/Model_fits_Comparison/IncomeRegion_model_Int.pdf",
    width = 12,
    height = 9)
ggplot()+
  geom_point(data = Income_Region_brmsInt_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "red4")+
  geom_errorbar(data = Income_Region_brmsInt_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "red4")+
  geom_point(data = Income_Region_Int_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "blue4",position=position_nudge(y = -0.18))+
  geom_errorbar(data = Income_Region_Int_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "blue4",position=position_nudge(y = -0.18))+
  ggtitle("Income-Region hierarchical estimates \n JAGS in blue and BRMS in red")+
  labs(x = "Intercept estimates", y = "Country")
dev.off()
```

#### Slope

```{r}
if (!dir.exists(here::here("Saved_Plots/Model_fits_Comparison")))
  dir.create(here::here("Saved_Plots/Model_fits_Comparison"))

#Independent model fit
pdf("Saved_Plots/Model_fits_Comparison/Independent_Country_model_Slope.pdf",
    width = 12,
    height = 9)
ggplot()+
  geom_point(data = Ind_Country_brmsSlop_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "red4")+
  geom_errorbar(data = Ind_Country_brmsSlop_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "red4")+
  geom_point(data = Ind_Country_Slop_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "blue4",position=position_nudge(y = -0.18))+
  geom_errorbar(data = Ind_Country_Slop_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "blue4",position=position_nudge(y = -0.18))+
  ggtitle("Independent linear fit estimates \n JAGS in blue and BRMS in red")+
  labs(x = "Slope estimates", y = "Country")
dev.off()

#Country model fit
pdf("Saved_Plots/Model_fits_Comparison/Country_model_Slope.pdf",
    width = 12,
    height = 9)
ggplot()+
  geom_point(data = Country_brmsSlop_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "red4")+
  geom_errorbar(data = Country_brmsSlop_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "red4")+
  geom_point(data = Country_Slop_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "blue4",position=position_nudge(y = -0.18))+
  geom_errorbar(data = Country_Slop_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "blue4",position=position_nudge(y = -0.18))+
  ggtitle("Country specific estimates \n JAGS in blue and BRMS in red")+
  labs(x = "Slope estimates", y = "Country")
dev.off()

# Region hierarchical model fit
pdf("Saved_Plots/Model_fits_Comparison/Region_model_Slop.pdf",
    width = 12,
    height = 9)
ggplot()+
  geom_point(data = Region_brmsSlop_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "red4")+
  geom_errorbar(data = Region_brmsSlop_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "red4")+
  geom_point(data = Region_Slop_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "blue4",position=position_nudge(y = -0.18))+
  geom_errorbar(data = Region_Slop_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "blue4",position=position_nudge(y = -0.18))+
  ggtitle("Region hierarchical estimates \n JAGS in blue and BRMS in red")+
  labs(x = "Slope estimates", y = "Country")
dev.off()

#Income hierarchical model fit
pdf("Saved_Plots/Model_fits_Comparison/Income model_Slop.pdf",
    width = 12,
    height = 9)
ggplot()+
  geom_point(data = Income_brmsSlop_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "red4")+
  geom_errorbar(data = Income_brmsSlop_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "red4")+
  geom_point(data = Income_Slop_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "blue4",position=position_nudge(y = -0.18))+
  geom_errorbar(data = Income_Slop_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "blue4",position=position_nudge(y = -0.18))+
  ggtitle("Income hierarchical estimates \n JAGS in blue and BRMS in red")+
  labs(x = "Slope estimates", y = "Country")
dev.off()


pdf("Saved_Plots/Model_fits_Comparison/IncomeRegion_model_Slop.pdf",
    width = 12,
    height = 9)
ggplot()+
  geom_point(data = Income_Region_brmsSlop_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "red4")+
  geom_errorbar(data = Income_Region_brmsSlop_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "red4")+
  geom_point(data = Income_Region_Slop_Est,
             aes(x= rvar, y = reorder(Country, rvar)), color = "blue4",position=position_nudge(y = -0.18))+
  geom_errorbar(data = Income_Region_Slop_Est,
                aes(xmin = .lower, xmax= .upper, y = Country), color = "blue4",position=position_nudge(y = -0.18))+
  ggtitle("Income-Region hierarchical estimates \n JAGS in blue and BRMS in red")+
  labs(x = "Slope estimates", y = "Country")
dev.off()
```

#### LOO- Comparison test

```{r}
BRMS_fit1 <- add_criterion(CountryInd_BRMSModel, "waic")
BRMS_fit2 <- add_criterion(Country_BRMSModel, "waic")
BRMS_fit3 <- add_criterion(Region_BRMSModel, "waic")
BRMS_fit4 <- add_criterion(Income_BRMSModel, "waic")
BRMS_fit5 <- add_criterion(IncomeRegion_BRMSModel, "waic")

loo_compare(BRMS_fit1, BRMS_fit2, BRMS_fit3, BRMS_fit4, BRMS_fit5, criterion = "waic")


#### Computing the DIC of the JAGS Model
Ind_C_Model$BUGSoutput$DIC
C_Model$BUGSoutput$DIC
Region_Model$BUGSoutput$DIC
Income_Model$BUGSoutput$DIC
IR_Model$BUGSoutput$DIC
```
```

