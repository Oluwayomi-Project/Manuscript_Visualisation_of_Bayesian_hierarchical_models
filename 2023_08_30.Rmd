---
title: "R Script for the manuscript"
author: "Oluwayomi Akinfenwa"
date: "30/08/2023"
output:
  html_document:
    toc: yes
    toc_depth: '4'
    df_print: paged
  bookdown::html_document2:
    toc: no
    toc_float: yes
    toc_depth: 4
    number_sections: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.duplicate.label = 'allow')
```

### Loading necessary packages

```{r, libraries, include = FALSE}
library(tidybayes)
library(ggplot2)
library(dplyr)
library(tidyr)
library(rjags)
library(R2jags)
```

Loading the two Rdata containing the learningtower data set and the processed data with Region and Income classification.

```{r loading the data}
load(here::here("SavedData", "pisam.Rdata"))
```

**We have 406 observations and for this analysis, we decided to examine European countries**

### Filtering European countries alone

```{r Europe}
Pisa_Europe_Data <- Pisa_Data |> filter(Continent == "Europe") |> arrange(Country)
```

**For the European countries, we have 230 observations from 40 countries.**

### Visualising the data

```{r}
# Joining the Income and Region together to form one new column
Pisa_Europe_Data <- unite(Pisa_Europe_Data, col = "Income_Region", c("Income", "Region"), 
                          sep = "_", remove = FALSE)

#Creating the grid for the prediction
country_names <- levels(factor(Pisa_Europe_Data$Country))
region_names <- levels(factor(Pisa_Europe_Data$Region))
income_names <- levels(factor(Pisa_Europe_Data$Income))
incomeregion_names <- levels(factor(Pisa_Europe_Data$Income_Region))

## Obtaining the index for the data
mu_index <- 1:nrow(Pisa_Europe_Data)

## Obtaining the region indexes

country_region <- Pisa_Europe_Data |> group_by(Country) |>
  summarise(Region=first(Region)) |>
  mutate(Country_num = as.numeric(as.factor(Country))) |>
  mutate(region_num = as.numeric(as.factor(Region)))

REGION <- country_region |> select(Country, Region)

## Obtaining the income indexes

country_income <- Pisa_Europe_Data |> group_by(Country) |>
  summarise(Income=first(Income)) |>
  mutate(Country_num = as.numeric(as.factor(Country))) |>
  mutate(income_num = as.numeric(as.factor(Income)))
         
INCOME <- country_income |> select(Country, Income)

## Obtaining the income_region indexes

country_incomeregion <- Pisa_Europe_Data |> group_by(Country) |>
  summarise(Income_Region=first(Income_Region)) |>
  mutate(Country_num = as.numeric(as.factor(Country))) |>
  mutate(incomeregion_num = as.numeric(as.factor(Income_Region)))
         
INCOME_REGION <- country_incomeregion |> select(Country, Income_Region)

pred_grid <- Pisa_Europe_Data |> 
  modelr::data_grid(Country, year_orig) |>
  mutate(Country_num = as.numeric(as.factor(Country)),
  Region = country_region$Region[Country_num],
  Income = country_income$Income[Country_num],
  Income_Region = country_incomeregion$Income_Region[Country_num]) |>
  mutate(region_num = as.numeric(as.factor(Region)),
         income_num = as.numeric(as.factor(Income)),
         incomeregion_num = as.numeric(as.factor(Income_Region)))

Country_region <- country_region |> left_join(INCOME, join_by(Country))
Country_income <- country_income |> left_join(REGION, join_by(Country))
Country_incomeregion <- country_incomeregion |> left_join(INCOME_REGION, join_by(Country))
```

## Setting the model parameter specification for JAGS

### Writing JAGS model for country-level specifications

```{r Countrymodel}
if (!dir.exists(here::here("Manuscript_Models")))
  dir.create(here::here("Manuscript_Models"))

if(file.exists(here::here("Manuscript_Models",
                          "Country_Model.Rdata"))){
  load(here::here("Manuscript_Models",
                          "Country_Model.Rdata"))
  countryJags <- FALSE
} else countryJags <- TRUE
```

```{r, eval = countryJags}
C_JAGS_Model = "
model{
# Data model
for (i in 1:n){
y.i[i] ~ dnorm(mu.i[i], sigma^-2)

mu.i[i] <- alpha.j[C[i]] + beta.j[C[i]]*(x.i[i])
}

# Prior on country alphas

for(j in 1:n_C){
alpha.j[j] ~ dnorm(mu_alpha, sigma_alpha^-2)
beta.j[j] ~ dnorm(mu_beta, sigma_beta^-2)
}

# Prior on sigma, model variation
sigma ~ dt (30, 10^-2,1)T(0,) # Truncated t-distribution
mu_alpha ~ dnorm(500, 100^-2)
mu_beta ~ dnorm(0, 5^-2)
sigma_alpha ~ dt(0, 5^-2,1)T(0,) # Truncated t-distribution
sigma_beta ~ dt( 0, 2^-2,1)T(0,) # Truncated t-distribution 


# Setting up the posterior
for(m in 1:n_pred){
ytilde[m] ~ dnorm(mu_pred.m[m], sigma^-2)
mu_pred.m[m] <- alpha.j[C_pred[m]] + beta.j[C_pred[m]] *(xpred.m[m])
}

# Setting up yrep for posterior predictive  checks
for (i in 1:n){
yrep[i] ~ dnorm(mu.i[i], sigma^-2)
}
}
"

## JAGS Model
C_Jags.data <- list(y.i = Pisa_Europe_Data$math,
                    x.i = Pisa_Europe_Data$year_orig,
                    n = nrow(Pisa_Europe_Data),
                    n_C = Pisa_Europe_Data$Country |> unique() |> length(),
                    C = as.numeric(factor(Pisa_Europe_Data$Country)),
                    n_pred = nrow(pred_grid),
                    C_pred = pred_grid$Country_num,
                    xpred.m = pred_grid$year_orig)

C_Parnames <- c("alpha.j","beta.j", "mu_alpha", "mu_beta","sigma","sigma_alpha",
                 "sigma_beta","ytilde", "yrep","mu_pred.m","mu.i")

# model
C_Model <- jags(data = C_Jags.data,
              parameters.to.save = C_Parnames,
              model.file = textConnection(C_JAGS_Model),
              n.iter = 10000,
              n.burnin = 2000,
              n.chains = 4,
              n.thin = 4)

save(C_Model, file=here::here("Manuscript_Models", "Country_Model.Rdata"))
```

**This C_MODEL fits a separate linear regression for each country, giving each country its distinct parameter estimates.**

# Hierarchical Model

## Region-based Country specific intercept and slope

### Region as a hierarchical structure.

```{r Regionmodel}
if (!dir.exists(here::here("Manuscript_Models")))
  dir.create(here::here("Manuscript_Models"))

if(file.exists(here::here("Manuscript_Models",
                          "Region_Model.Rdata"))){
  load(here::here("Manuscript_Models",
                          "Region_Model.Rdata"))
  regionJags <- FALSE
} else regionJags <- TRUE
```

```{r, eval = regionJags}
hmregion = "
model{
# Data model
for (i in 1:n){
y.i[i] ~ dnorm(mu.i[i], sigma^-2)

mu.i[i] <- alpha.j[C[i]] + beta.j[C[i]]*(x.i[i] )
}

# Prior on alphas to vary by region

for(j in 1:n_C){
alpha.j[j] ~ dnorm(mu_alpha.r[R[j]], sigma_alpha[R[j]]^-2)
beta.j[j] ~ dnorm(mu_beta.r[R[j]], sigma_beta^-2)
}

for (r in 1:n_R){
mu_alpha.r[r] ~ dnorm(mu_alpha_eur, sigma_alpha.r^-2)
mu_beta.r[r] ~ dnorm(mu_beta_eur, sigma_beta.r^-2)
sigma_alpha[r] ~ dt( 0, 1^-2,1)T(0,) # Truncated t-distribution
}

# Prior on sigma, model variation
sigma ~ dt (30, 10^-2,1)T(0,) # Truncated t-distribution

# Prior on alpha hyper-parameters
mu_alpha_eur ~ dnorm(500, 100^-2)
sigma_alpha.r ~ dt( 0, 5^-2,1)T(0,) # Truncated t-distribution

# Prior on beta hyper-parameters
mu_beta_eur ~ dnorm(0, 5^-2)
sigma_beta ~ dt( 30, 10^-2,1)T(0,) # Truncated t-distribution 
sigma_beta.r ~ dt( 0, 3^-2,1)T(0,) # Truncated t-distribution


for(m in 1:n_pred){
ytilde[m] ~ dnorm(mu_pred.m[m], sigma^-2)
mu_pred.m[m] <- alpha.j[C_pred[m]] + beta.j[C_pred[m]] *(xpred.m[m])
}

# Setting up yrep for posterior predictive  checks
for (i in 1:n){
yrep[i] ~ dnorm(mu.i[i], sigma^-2)
}
}
"

## JAGS Model

R_Jags.data <- list(y.i = Pisa_Europe_Data$math,
                  x.i = Pisa_Europe_Data$year_orig,
                  n = nrow(Pisa_Europe_Data),
                  n_C = Pisa_Europe_Data$Country %>% unique() %>% length(),
                  C = as.numeric(factor(Pisa_Europe_Data$Country)),
                  R = country_region$region_num,
                  n_pred = nrow(pred_grid),
                  C_pred = pred_grid$Country_num,
                  xpred.m = pred_grid$year_orig,
                  n_R = Pisa_Europe_Data$Region %>% unique() %>% length())

R_Parnames <- c( "alpha.j","beta.j","sigma","sigma_alpha","sigma_beta","mu_alpha.r", 
               "mu_beta.r","mu_alpha_eur","mu_beta_eur", "ytilde", "yrep", "mu_pred.m", 
               "mu.i" ,"sigma_alpha.r", "sigma_beta.r")

# model
Region_Model <- jags(data = R_Jags.data,
              parameters.to.save = R_Parnames,
              model.file = textConnection(hmregion),
              n.iter = 10000,
              n.burnin = 2000,
              n.chains = 4,
              n.thin = 4)

save(Region_Model, file=here::here("Manuscript_Models", "Region_Model.Rdata"))
```

**R_Model fits a hierarchical model on the Pisa_Europe_Data by estimating the model parameters based on the estimates from its different level of hierarchy (geographical region)**

### Income as a hierarchical structure.

```{r Incomemodel}
if (!dir.exists(here::here("Manuscript_Models")))
  dir.create(here::here("Manuscript_Models"))

if(file.exists(here::here("Manuscript_Models",
                          "Income_Model.Rdata"))){
  load(here::here("Manuscript_Models",
                          "Income_Model.Rdata"))
  incomeJags <- FALSE
} else incomeJags <- TRUE
```

```{r, eval = incomeJags}
hmincome = "
model{
# Data model
for (i in 1:n){
y.i[i] ~ dnorm(mu.i[i], sigma^-2)

mu.i[i] <- alpha.j[C[i]] + beta.j[C[i]]*(x.i[i])
}

# Prior on alphas to vary by income

for(j in 1:n_C){
alpha.j[j] ~ dnorm(mu_alpha.I[I[j]], sigma_alpha[I[j]]^-2)
beta.j[j] ~ dnorm(mu_beta.I[I[j]], sigma_beta^-2)
}

for (r in 1:n_I){
mu_alpha.I[r] ~ dnorm(mu_alpha_inc, sigma_alpha.inc^-2)
mu_beta.I[r] ~ dnorm(mu_beta_inc, sigma_beta.inc^-2)
sigma_alpha[r] ~ dt( 0, 5^-2,1)T(0,) # Truncated t-distribution
}

# Prior on sigma, model variation
sigma ~ dt (30, 10^-2,1)T(0,) # Truncated t-distribution

# Prior on alpha hyper-parameters
mu_alpha_inc ~ dnorm(500, 100^-2)
sigma_alpha.inc ~ dt( 30, 10^-2,1)T(0,) # Truncated t-distribution

# Prior on beta hyper-parameters
mu_beta_inc ~ dnorm(0, 5^-2)
sigma_beta ~ dt( 30, 10^-2,1)T(0,) # Truncated t-distribution
sigma_beta.inc ~ dt( 30, 10^-2,1)T(0,) # Truncated t-distribution


for(m in 1:n_pred){
ytilde[m] ~ dnorm(mu_pred.m[m], sigma^-2)
mu_pred.m[m] <- alpha.j[C_pred[m]] + beta.j[C_pred[m]] *(xpred.m[m] - mean(xpred.m))
}

# Setting up yrep for posterior predictive  checks
for (i in 1:n){
yrep[i] ~ dnorm(mu.i[i], sigma^-2)
}
}
"

## JAGS Model

I_Jags.data <- list(y.i = Pisa_Europe_Data$math,
                    x.i = Pisa_Europe_Data$year_orig,
                    n = nrow(Pisa_Europe_Data),
                    n_C = Pisa_Europe_Data$Country %>% unique() %>% length(),
                    C = as.numeric(factor(Pisa_Europe_Data$Country)),
                    I = country_income$income_num,
                    n_pred = nrow(pred_grid),
                    C_pred = pred_grid$Country_num,
                    xpred.m = pred_grid$year_orig,
                    n_I = Pisa_Europe_Data$Income %>% unique() %>% length())

I_Parnames <- c( "alpha.j","beta.j","sigma","sigma_alpha","sigma_beta","mu_alpha.I", 
                 "mu_beta.I","mu_alpha_inc","mu_beta_inc", "ytilde", "yrep", "mu_pred.m", 
                 "mu.i" ,"sigma_alpha.inc", "sigma_beta.inc")

# model
Income_Model <- jags(data = I_Jags.data,
                parameters.to.save = I_Parnames,
                model.file = textConnection(hmincome),
                n.iter = 10000,
                n.burnin = 2000,
                n.chains = 4,
                n.thin = 4)

save(Income_Model, file=here::here("Manuscript_Models", "Income_Model.Rdata"))
```

**I_Model fits a hierarchical model on the Pisa_Europe_Data by estimating the model parameters based on the estimates from its different level of hierarchy (income classification)**

### Income_Region as a hierarchical structure.

```{r IncomeRegionmodel}
if (!dir.exists(here::here("Manuscript_Models")))
  dir.create(here::here("Manuscript_Models"))

if(file.exists(here::here("Manuscript_Models",
                          "IncomeRegion_Model.Rdata"))){
  load(here::here("Manuscript_Models",
                          "IncomeRegion_Model.Rdata"))
  incomeregionJags <- FALSE
} else incomeregionJags <- TRUE
```

```{r, eval=incomeregionJags}
hmincome_region = "
model{
# Data model
for (i in 1:n){
y.i[i] ~ dnorm(mu.i[i], sigma^-2)

mu.i[i] <- alpha.j[C[i]] + beta.j[C[i]]*(x.i[i] - mean(x.i))
}

# Prior on alphas to vary by income

for(j in 1:n_C){
alpha.j[j] ~ dnorm(mu_alpha.IR[IR[j]], sigma_alpha[IR[j]]^-2)
beta.j[j] ~ dnorm(mu_beta.IR[IR[j]], sigma_beta^-2)
}

for (r in 1:n_IR){
mu_alpha.IR[r] ~ dnorm(mu_alpha_inre, sigma_alpha.inre^-2)
mu_beta.IR[r] ~ dnorm(mu_beta_inre, sigma_beta.inre^-2)
sigma_alpha[r] ~ dt( 0, 5^-2,1)T(0,) # Truncated t-distribution
}

# Prior on sigma, model variation
sigma ~ dt (30, 10^-2,1)T(0,) # Truncated t-distribution

# Prior on alpha hyper-parameters
mu_alpha_inre ~ dnorm(500, 100^-2)
sigma_alpha.inre ~ dt( 30, 10^-2,1)T(0,) # Truncated t-distribution

# Prior on beta hyper-parameters
mu_beta_inre ~ dnorm(0, 5^-2)
sigma_beta ~ dt( 30, 10^-2,1)T(0,) # Truncated t-distribution
sigma_beta.inre ~ dt( 30, 10^-2,1)T(0,) # Truncated t-distribution


for(m in 1:n_pred){
ytilde[m] ~ dnorm(mu_pred.m[m], sigma^-2)
mu_pred.m[m] <- alpha.j[C_pred[m]] + beta.j[C_pred[m]] *(xpred.m[m] - mean(xpred.m))
}

# Setting up yrep for posterior predictive  checks
for (i in 1:n){
yrep[i] ~ dnorm(mu.i[i], sigma^-2)
}
}
"
IR_Jags.data <- list(y.i = Pisa_Europe_Data$math,
                    x.i = Pisa_Europe_Data$year_orig,
                    n = nrow(Pisa_Europe_Data),
                    n_C = Pisa_Europe_Data$Country %>% unique() %>% length(),
                    C = as.numeric(factor(Pisa_Europe_Data$Country)),
                    IR = country_incomeregion$incomeregion_num,
                    n_pred = nrow(pred_grid),
                    C_pred = pred_grid$Country_num,
                    xpred.m = pred_grid$year_orig,
                    n_IR = Pisa_Europe_Data$Income_Region %>% unique() %>% length())

IR_Parnames <- c( "alpha.j","beta.j","sigma","sigma_alpha","sigma_beta","mu_alpha.IR", 
                 "mu_beta.IR","mu_alpha_inre","mu_beta_inre", "ytilde", "yrep", "mu_pred.m", 
                 "mu.i" ,"sigma_alpha.inre", "sigma_beta.inre")
# model
IR_Model <- jags(data = IR_Jags.data,
                parameters.to.save = IR_Parnames,
                model.file = textConnection(hmincome_region),
                n.iter = 10000,
                n.burnin = 2000,
                n.chains = 4,
                n.thin = 4)

save(IR_Model, file=here::here("Manuscript_Models", "IncomeRegion_Model.Rdata"))
```

## Results

### Estimates from the country-specific model

## Results

### Estimates from the country-specific model

```{r}
Country_ModelSample <- C_Model$BUGSoutput$sims.matrix

CountryI <- spread_rvars(Country_ModelSample , alpha.j[Country_index]) |>
  mutate(Country = country_names[Country_index], term="Intercept") |>
  select(Country, term,rvar=alpha.j)


CountryS <- spread_rvars(Country_ModelSample , beta.j[Country_index]) |>
  mutate(Country = country_names[Country_index], term="year_orig") |>
  select(Country, term,rvar=beta.j)

CountryIS <- rbind(CountryI, CountryS)


Country_IS_Est <- CountryIS |> mutate(coef=median(rvar))|> 
  select(-rvar, Country)|>
  pivot_wider(values_from=coef, names_from=term)
```

### The country-specific plot

```{r}
ggplot(Pisa_Europe_Data, aes(x=year_orig, y=math))+ 
  geom_point(color = "blue3")+ facet_wrap(~Country, nrow = 5) +
  geom_abline(data=Country_IS_Est, aes(slope=year_orig, intercept= Intercept), color="black")+
  scale_x_continuous(labels = function(x) x+2000, breaks = seq(0,18,3))+ xlab("year")+
   ylab("Average maths score") +theme_bw()+
  theme(legend.position = "bottom",
        plot.subtitle = element_text(family = "Serif"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
```

### Estimates from the region hierarchical model

```{r}
Region_ModelSamples <- Region_Model$BUGSoutput$sims.matrix
# get_variables(Region_ModelSamples)


Region_I <- spread_rvars(Region_ModelSamples , mu_alpha.r[region_num]) |>
  mutate(Region = region_names[region_num], term = "Intercept") |>
  rename(rvar =mu_alpha.r) |>
  select(Region, term,rvar)

Region_S <- spread_rvars(Region_ModelSamples , mu_beta.r[region_num]) |>
  mutate(Region = region_names[region_num], term = "year_orig") |>
  rename(rvar =mu_beta.r) |>
  select(Region, term,rvar)

Region_IS <- rbind(Region_I, Region_S)


## The region country estimates
Rcountry_I <- spread_rvars(Region_ModelSamples , alpha.j[country_num]) |>
  mutate(Country = country_names[country_num], term = "Intercept") |>
  right_join(Country_region, by = join_by(Country==Country))|>
  rename(rvar =alpha.j,Country = Country) |>
  select(Country, Region,Income, term,rvar)


Rcountry_S <- spread_rvars(Region_ModelSamples , beta.j[country_num]) |>
  mutate(Country = country_names[country_num], term = "year_orig") |>
  right_join(Country_region, by = join_by(Country==Country))|>
  rename(rvar =beta.j,Country = Country) |>
  select(Country, Region,Income, term,rvar)

Rcountry_IS <- rbind(Rcountry_I, Rcountry_S) 
```

### Plots to compare the region hierarchy fits on the data

```{r, fig.width=10, fig.height=8}
Region_IS_Est <- Region_IS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)

Rcountry_IS_Est <- Rcountry_IS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)

### Creating a boxplot for both intercept and slope

ggplot(data = Rcountry_IS_Est)+
  geom_boxplot(aes(x= Region, y = Intercept))

#OR
# Pulling out the mu_i
R_mu <- spread_rvars(Region_ModelSamples , mu.i[mu_index]) 

Region_mu <- Pisa_Europe_Data |>  mutate(mu_i = median(R_mu$mu.i)) |>
  select(c(year, year_orig, Country, Region, mu_i))

# Creating a boxplot with the mu_i's
ggplot(data = Region_mu)+
  geom_boxplot(aes(x = Country, y = mu_i, color = Region))

# Why not filter countries in each region and plot the intercept separately
ggplot(data = filter(Region_mu, Region == "Eastern Europe")) +
  geom_boxplot(aes(x= Country, y = mu_i)) +
  geom_hline (aes(yintercept= Region_IS_Est$Intercept[1]))+
  xlab("Eastern Europe") + ylab("Intercept")

ggplot(data = filter(Region_mu, Region == "Northern Europe")) +
  geom_boxplot(aes(x= Country, y = mu_i)) +
  geom_hline (aes(yintercept= Region_IS_Est$Intercept[2]))+
  xlab("Northern Europe") + ylab("Intercept")

ggplot(data = filter(Region_mu, Region == "Southern Europe")) +
  geom_boxplot(aes(x= Country, y = mu_i)) +
  geom_hline (aes(yintercept= Region_IS_Est$Intercept[3]))+
  xlab("Southern Europe") + ylab("Intercept")

ggplot(data = filter(Region_mu, Region == "Western Europe")) +
  geom_boxplot(aes(x= Country, y = mu_i)) +
  geom_hline (aes(yintercept= Region_IS_Est$Intercept[4]))+
  xlab("Western Europe") + ylab("Intercept")

```

The initial plot was a plot showing the fits on the data based on the Region hierarchical structure.

```{r}
ggplot(Pisa_Europe_Data, aes(x=year_orig, y=math, color = Region))+ 
  geom_point()+
  ggh4x::facet_nested_wrap(vars(Region, Country), nrow = 5)+
   geom_abline(data=Rcountry_IS_Est, aes(slope=year_orig, intercept= Intercept), color="black")+
  scale_x_continuous(labels = function(x) {x+2000}, breaks = seq(0,18,3))+
  xlab("year")+ ylab("Average maths score")+
  theme_bw()+
  theme(panel.spacing=unit(1,"lines"),
        legend.position = "bottom",
        plot.subtitle = element_text(family = "Serif"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
```


### Estimates from the income hierarchical model

```{r}
Income_ModelSamples <- Income_Model$BUGSoutput$sims.matrix
# get_variables(Income_ModelSamples)
Income_I <- spread_rvars(Income_ModelSamples , mu_alpha.I[income_num]) |>
  mutate(Income = income_names[income_num], term = "Intercept") |>
  rename(rvar =mu_alpha.I) |>
  select(Income, term,rvar)

Income_S <- spread_rvars(Income_ModelSamples , mu_beta.I[income_num]) |>
  mutate(Income = income_names[income_num], term = "year_orig") |>
  rename(rvar =mu_beta.I) |>
  select(Income, term,rvar)

Income_IS <- rbind(Income_I, Income_S)

## The income country estimates
Icountry_I <- spread_rvars(Income_ModelSamples , alpha.j[country_num]) |>
  mutate(Country = country_names[country_num], term = "Intercept") |>
  right_join(Country_income, by = join_by(Country==Country))|>
  rename(rvar =alpha.j, Country=Country) |>
  select(Country, Income,Region, term,rvar)


Icountry_S <- spread_rvars(Income_ModelSamples , beta.j[country_num]) |>
  mutate(Country = country_names[country_num], term = "year_orig") |>
  right_join(Country_income, by = join_by(Country==Country))|>
  rename(rvar =beta.j,Country=Country) |>
  select(Country, Income,Region, term,rvar)

Icountry_IS <- rbind(Icountry_I, Icountry_S) 
```

### Plots to compare the Income hierarchy fits on the data

```{r, fig.width=10, fig.height=8}
INCOME_IS_EST <- Income_IS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)

Income_IS_Est <- Icountry_IS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)

ggplot(Pisa_Europe_Data, aes(x=year_orig, y=math, color = Income))+ 
  geom_point()+
  ggh4x::facet_nested_wrap(vars(Income, Country), nrow = 5)+
   geom_abline(data=Income_IS_Est, aes(slope=year_orig, intercept= Intercept), color="black")+
  scale_x_continuous(labels = function(x) {x+2000}, breaks = seq(0,18,3))+
  xlab("year")+ ylab("Average maths score")+
  theme_bw()+
  theme(panel.spacing=unit(1,"lines"),
        legend.position = "bottom",
        plot.subtitle = element_text(family = "Serif"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
```

Creating a boxplot for the Income hierarchy

```{r}
# Pulling out the mu_i
I_mu <- spread_rvars(Income_ModelSamples , mu.i[mu_index]) 

Income_mu <- Pisa_Europe_Data |>  mutate(mu_i = median(I_mu$mu.i)) |>
  select(c(year, year_orig, Country, Income, mu_i))

# Creating a boxplot with the mu_i's
ggplot(data = Income_mu)+
  geom_boxplot(aes(x = Country, y = mu_i, color = Income))

# Why not filter countries in each region and plot the intercept separately
ggplot(data = filter(Income_mu,Income == "Middle Income")) +
  geom_boxplot(aes(x= Country, y = mu_i)) +
  geom_hline (aes(yintercept= INCOME_IS_EST$Intercept[1]))+
  xlab("Middle Income") + ylab("Intercept")

ggplot(data = filter(Income_mu,Income == "High Income")) +
  geom_boxplot(aes(x= Country, y = mu_i)) +
  geom_hline (aes(yintercept= INCOME_IS_EST$Intercept[2]))+
  xlab("High Income") + ylab("Intercept")
```


### Estimates from the incomeregion hierarchical model

```{r}
IR_ModelSamples <- IR_Model$BUGSoutput$sims.matrix
# get_variables(IR_ModelSamples)
IncomeRegion_I <- spread_rvars(IR_ModelSamples , mu_alpha.IR[income_num]) |>
  mutate(Income = incomeregion_names[income_num], term = "Intercept") |>
  rename(rvar =mu_alpha.IR) |>
  select(Income, term,rvar)

IncomeRegion_S <- spread_rvars(IR_ModelSamples , mu_beta.IR[income_num]) |>
  mutate(Income = incomeregion_names[income_num], term = "year_orig") |>
  rename(rvar =mu_beta.IR) |>
  select(Income, term,rvar)

IncomeRegion_IS <- rbind(IncomeRegion_I, IncomeRegion_S)

## The income country estimates
IRcountry_I <- spread_rvars(IR_ModelSamples , alpha.j[country_num]) |>
  mutate(Country = country_names[country_num], term = "Intercept") |>
  right_join(country_incomeregion, by = join_by(Country==Country))|>
  rename(rvar =alpha.j, Country=Country) |>
  select(Country, Income_Region, term,rvar)


IRcountry_S <- spread_rvars(IR_ModelSamples , beta.j[country_num]) |>
  mutate(Country = country_names[country_num], term = "year_orig") |>
  right_join(country_incomeregion, by = join_by(Country==Country))|>
  rename(rvar =beta.j,Country=Country) |>
  select(Country, Income_Region, term,rvar)

IRcountry_IS <- rbind(IRcountry_I, IRcountry_S) 
```

### Plots to compare the IncomeRegion hierarchy fits on the data

```{r, fig.width=10, fig.height=8}
IR_IS_EST <- IncomeRegion_IS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)

IncomeRegion_IS_Est <- IRcountry_IS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)

ggplot(Pisa_Europe_Data, aes(x=year_orig, y=math, color = Income_Region))+ 
  geom_point()+
  ggh4x::facet_nested_wrap(vars(Income_Region, Country), nrow = 5)+
   geom_abline(data=IncomeRegion_IS_Est, aes(slope=year_orig, intercept= Intercept), color="black")+
  scale_x_continuous(labels = function(x) {x+2000}, breaks = seq(0,18,3))+
  xlab("year")+ ylab("Average maths score")+
  theme_bw()+
  theme(panel.spacing=unit(1,"lines"),
        legend.position = "bottom",
        plot.subtitle = element_text(family = "Serif"),
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
```

## Creating boxplot for the incomeregion fit

```{r}
# Pulling out the mu_i
IR_mu <- spread_rvars(IR_ModelSamples , mu.i[mu_index]) 

IncomeRegion_mu <- Pisa_Europe_Data |>  mutate(mu_i = median(IR_mu$mu.i)) |>
  select(c(year, year_orig, Country, Income_Region, mu_i))

# Creating a boxplot with the mu_i's
ggplot(data = IncomeRegion_mu)+
  geom_boxplot(aes(x = Country, y = mu_i, color = Income_Region))

# Why not filter countries in each region and plot the intercept separately
ggplot(data = filter(IncomeRegion_mu,Income_Region == "High Income_Eastern Europe")) +
  geom_boxplot(aes(x= Country, y = mu_i)) +
  geom_hline (aes(yintercept= IR_IS_EST$Intercept[1]))+
  xlab("High Income_Eastern Europe") + ylab("Intercept")

ggplot(data = filter(IncomeRegion_mu,Income_Region == "High Income_Northern Europe")) +
  geom_boxplot(aes(x= Country, y = mu_i)) +
  geom_hline (aes(yintercept= IR_IS_EST$Intercept[2]))+
  xlab("High Income_Northern Europe") + ylab("Intercept")

ggplot(data = filter(IncomeRegion_mu,Income_Region == "High Income_Southern Europe")) +
  geom_boxplot(aes(x= Country, y = mu_i)) +
  geom_hline (aes(yintercept= IR_IS_EST$Intercept[3]))+
  xlab("High Income_Southern Europe") + ylab("Intercept")

ggplot(data = filter(IncomeRegion_mu,Income_Region == "High Income_Western Europe")) +
  geom_boxplot(aes(x= Country, y = mu_i)) +
  geom_hline (aes(yintercept= IR_IS_EST$Intercept[4]))+
  xlab("High Income_Western Europe") + ylab("Intercept")

ggplot(data = filter(IncomeRegion_mu,Income_Region == "Middle Income_Eastern Europe")) +
  geom_boxplot(aes(x= Country, y = mu_i)) +
  geom_hline (aes(yintercept= IR_IS_EST$Intercept[5]))+
  xlab("Middle Income_Eastern Europe") + ylab("Intercept")

ggplot(data = filter(IncomeRegion_mu,Income_Region == "Middle Income_Southern Europe")) +
  geom_boxplot(aes(x= Country, y = mu_i)) +
  geom_hline (aes(yintercept= IR_IS_EST$Intercept[6]))+
  xlab("Middle Income_Southern Europe") + ylab("Intercept")
```

## THE STAR-PLOT

### Intercept
```{r}
X <- Country_IS_Est |>
  select(-year_orig) |>
  rename(Country_Model = Intercept) |>
  mutate(Region_Model = Rcountry_IS_Est$Intercept,
         Income_Model = Income_IS_Est$Intercept,
         IncomeRegion_Model = IncomeRegion_IS_Est$Intercept)|>
  select(c(Country, Country_Model, Region_Model, Income_Model, IncomeRegion_Model))
  

x <- X[1:40,] # Storing the results
r <- range(x[, 2:5]) # obtaining the range of the estimates from the 4 models
r[1] <- r[1] - 1.2 *(r[2] - r[1])

x[, 2:5] <- scale(x[, 2:5], center=rep(r[1], 4), scale=rep(r[2]- r[1],4))

stars(x[, 2:5], labels = paste(x$Country), cex = .5, 
      col.stars=rep("aquamarine", 40), ncol=8)
```

### Slope

```{r}
Y <- Country_IS_Est |>
  select(-Intercept) |>
  rename(Country_Model = year_orig) |>
  mutate(Region_Model = Rcountry_IS_Est$year_orig,
         Income_Model = Income_IS_Est$year_orig,
         IncomeRegion_Model = IncomeRegion_IS_Est$year_orig)|>
  select(c(Country, Country_Model, Region_Model, Income_Model, IncomeRegion_Model))
  

y <- Y[1:40,] # Storing the results
r <- range(y[, 2:5]) # obtaining the range of the estimates from the 4 models
r[1] <- r[1] - 1.2 *(r[2] - r[1])

y[, 2:5] <- scale(y[, 2:5], center=rep(r[1], 4), scale=rep(r[2]- r[1],4))

stars(y[, 2:5], labels = paste(y$Country), cex = .5, 
      col.stars=rep("aquamarine4", 40), ncol=8)
```
