---
title: "Exploratory data analysis for the new data"
author: "Oluwayomi Akinfenwa"
date: "29/01/2024"
output:
  pdf_document:
    toc: yes
    toc_depth: '4'
  bookdown::html_document2:
    toc: no
    toc_float: yes
    toc_depth: 4
    number_sections: yes
  html_document:
    toc: yes
    toc_depth: '4'
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.duplicate.label = 'allow')
```

Creating a folder to store all the plots

```{r, libraries, include = FALSE}
if (!dir.exists(here::here("Saved_Plots")))
  dir.create(here::here("Saved_Plots"))
```


### Loading necessary packages

```{r, libraries, include = FALSE}
library(lme4)
library(tidybayes)
library(ggplot2)
library(dplyr)
library(tidyr)
library(rjags)
library(R2jags)
library(bayesplot)
library(patchwork)
library(ggragged)
```

Loading the R.data containing the average maths scores of PISA data from 2003 to 2022.

```{r loading the data}
load(here::here("Saved_PISA_Data", "pisamaths.Rdata"))

```

**We have 439 observations and for this analysis, we decided to examine European countries**

### Filtering European countries alone

```{r Europe}
Pisa_Europe_Data <- PISA_Data |> filter(Continent == "Europe") |> arrange(Country)
```

**For the European countries, we have 237 observations from 40 countries.**

### Creating a new variable by merging both region and income together.

```{r PISA_Europe}
PISA_Europe <- here::here("Saved_PISA_Data", "Europe_Pisamaths.Rdata")

# Joining the Income and Region together to form one new column
Pisa_Europe_Data <- unite(Pisa_Europe_Data, col = "Income_Region", c("Income", "Region"), sep = "_ ", remove = FALSE)

save(Pisa_Europe_Data, file =PISA_Europe)
```

**We have decided to remove year 2022 from my data and make prediction for 2022.**

**Hence i will filter year = 2022.**

```{r}
# rename sigma as se_y
PISA_Europe_Data <- Pisa_Europe_Data |>
  filter(year != "2022") |>
  rename(se_y = sigma) |>
  mutate(weight = 1/(se_y^2))
```

### Exploratory data analysis

**Fitting a linear regression model on the data set**

```{r}
library(broom)
## The function reframe- creates a new data-frame by applying functions (in the previous line of code) to columns of an existing data frame.

#Weighted least squares. The weight is the reciprocal of the square of the standard error.
Country_Model <- PISA_Europe_Data |>
  nest_by(Country) |>
  mutate(mod = list(lm(math ~ year_orig, weights = weight, data = data))) |>
  reframe(tidy(mod))|>
   select(Country, term, estimate)

### Tidying the estimates
### We are interested in arranging the countries according to their increasing slope.
Country_Model_IS <- Country_Model  |>
   pivot_wider(values_from = estimate, names_from = term) |>
   rename("slope" = "year_orig") |>
  mutate(slopesign = sign(slope)) |>
  left_join(Country_region, join_by(Country)) |>
  select(-c(Country_num, region_num)) |>
  arrange(slope)
```

#### Visualisation - Grouped by region.

```{r}
##Merging the slope-sign with the Pisa data so that i can rearrange by both country and slope-sign

Slopesign <- Country_Model_IS |>
  select(Country, slope)

PISA_Europe_Data1 <- PISA_Europe_Data |>
  left_join(Slopesign, join_by(Country))

PISA_Europe_Data1$facet <- factor(PISA_Europe_Data1$Region, 
                  levels = c("Western Europe", "Northern Europe", "Eastern Europe","Southern Europe"))

Country_Model_IS$facet <- factor(Country_Model_IS$Region, 
                  levels = c("Western Europe","Northern Europe","Eastern Europe", "Southern Europe"))

Labels <- c("2003", "2006", "2009", "2012", "2015", "2018")

Region_color_flag <- c("Eastern Europe" = "steelblue3",
                      "Northern Europe"="darkolivegreen3", 
                      "Southern Europe"="indianred", 
                      "Western Europe"="cyan1")

strip <- ggh4x::strip_themed(background_x = ggh4x::elem_list_rect(fill = Region_color_flag))

if (!dir.exists(here::here("BAYSM_2024/Saved_Plots")))
  dir.create(here::here("BAYSM_2024/Saved_Plots"))

## In ascending slope
pdf("Saved_Plots/fit_grouped_by region.pdf",
    width = 12,
    height = 9)
ggplot(data = PISA_Europe_Data1,
         aes(x=year_orig, y=math))+
  geom_point(color = "grey35")+
   geom_abline(data= Country_Model_IS, 
               aes(slope=slope, intercept= `(Intercept)`,color = factor(slopesign)))+
  facet_ragged_rows(vars(facet), vars(reorder(Country, slope)),scales = "free_y",
                    switch = "y", labeller=label_wrap_gen(width=6))+
  scale_x_continuous(breaks = c(0, 3,6,9,12,15), labels = Labels) +
  scale_y_continuous(position = "right")+
   labs(x= " ", y = " ",  color = "Slope") + 
  scale_color_manual(values = c("maroon", "blue3"), labels = c("negative", "positive"), na.translate = F)+
  theme(legend.position = "bottom", legend.box.spacing = unit(-0.6, "lines"),
        legend.text = element_text(size = 11.5),
        panel.spacing.y = unit(1.2, "lines"),
        plot.subtitle = element_text(family = "Serif"),
        axis.text.x = element_text(angle = 55, hjust = 0.5, vjust = 0.5,size = 8.5, face = "bold"),strip.text.x = element_text(size = 9.4,face = "bold"),
        strip.text.y = element_text(size = 10,face = "bold"),
        axis.text.y = element_text(size = 10,face = "bold"))+
  ggtitle("Separate linear model fit of average math scores for each country")
dev.off()
```

#### Visualisation - Grouped by region.

```{r}
pdf("Saved_Plots/fit_grouped_by income.pdf",
    width = 11.5,
    height = 9.3)

middle_income <- ggplot(data = filter(PISA_Europe_Data1, Income== "Middle Income"),
         aes(x=year_orig, y=math))+
  geom_point(color = "grey35")+
   geom_abline(data= filter(Country_Model_IS, Income== "Middle Income"), 
               aes(slope=slope, intercept= `(Intercept)`),color = "blue")+
  ggh4x::facet_wrap2(vars(Income, reorder(Country, slope)), ncol = 10,
  strip = ggh4x::strip_nested(bleed = TRUE))+
  labs(x = " ", y = " ") +
  scale_y_continuous(position = "right",breaks = seq(350,500, 50))+
  scale_x_continuous(breaks = c(0, 3,6,9,12,15), labels = Labels) +
  theme(strip.background = element_rect(fill="aquamarine3"),
    strip.text.x = element_text(size = 9.9,face = "bold"),
        axis.text.y = element_text(size = 10,face = "bold"), 
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5,face = "bold"),
        plot.title = element_text(hjust = 0.5))

high_income <- ggplot(data = filter(PISA_Europe_Data1, Income== "High Income"),
         aes(x=year_orig, y=math))+
   geom_point(color = "grey35")+
   geom_abline(data= filter(Country_Model_IS, Income== "High Income"), 
               aes(slope=slope, intercept= `(Intercept)`,color = factor(slopesign)))+
  scale_y_continuous(position = "right")+
  ggh4x::facet_wrap2(vars(Income, reorder(Country, slope)), ncol = 10, 
                     strip = ggh4x::strip_nested(bleed = TRUE))+
  ggtitle("Separate linear model fit of average math scores for each country")+
  scale_color_manual(values = c("maroon", "blue"), labels = c("negative", "positive"))+ 
  labs(x = " ", y = " ", color = "Slope") +
  scale_x_continuous(breaks = c(0, 3,6,9,12,15), labels = Labels) +
  theme(strip.background = element_rect(fill="tan"),
    strip.text.x = element_text(size = 9.5,face = "bold"),
        axis.text.y = element_text(size = 10,face = "bold"),
        axis.text.x = element_blank(),
        axis.ticks.x=element_blank(),
        panel.spacing.y = unit(1, "lines"),
        legend.text = element_text(size = 11.5),
        plot.title = element_text(hjust = 0.5))

high_income/middle_income +
  plot_layout(widths = 1, heights = c(5, 1), guides = "collect") &
   theme(legend.position = "bottom",
         legend.box.spacing = unit(-0.6, "lines"))

dev.off()
```


```{r}
pdf("Saved_Plots/fit_grouped_by REGION.pdf",
    width = 11.5,
    height = 9.3)
P <- ggplot(data = PISA_Europe_Data1,
            aes(x=year_orig, y=math))+
  geom_point(color = "grey35")+
  geom_abline(data= Country_Model_IS, 
              aes(slope=slope, intercept= `(Intercept)`,color = factor(slopesign)))+
  facet_ragged_rows(vars(facet = facet), 
                    vars(reorder(Country, slope)),
                    scales = "free_y",
                    #switch = "y",
                  labeller=label_wrap_gen(width=6))+
  scale_x_continuous(breaks = c(0, 3,6,9,12,15), labels = Labels) +
  scale_y_continuous(position = "right")+
  labs(x= " ", y = " ",  color = "Slope") + 
  scale_color_manual(values = c("maroon", "blue3"), labels = c("negative", "positive"), na.translate = F)+
  theme(legend.position = "bottom", legend.box.spacing = unit(-0.6, "lines"),
        legend.text = element_text(size = 11.5),
        panel.spacing.y = unit(1.2, "lines"),
        plot.subtitle = element_text(family = "Serif"),
        axis.text.x = element_text(angle = 55, hjust = 0.5, vjust = 0.5,size = 8.5, face = "bold"),strip.text.x = element_text(size = 9.4,face = "bold"),
        strip.text.y = element_text(size = 10,face = "bold"),
        axis.text.y = element_text(size = 10,face = "bold"))+
  ggtitle("Separate linear model fit of average math scores for each country")


g <- ggplot_gtable(ggplot_build(P))


stripr <- which(grepl('strip-l', g$layout$name))
fills <- c("red","green","blue","yellow")
k <- 1
for (i in stripr) {
  j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder))
  g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]
  k <- k+1
}

grid.draw(g)

dev.off()
```

