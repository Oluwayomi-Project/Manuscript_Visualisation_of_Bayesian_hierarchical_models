---
title: "The Bayesian hierarchical models for Region, Income and Income-Region"
author: "Oluwayomi Akinfenwa"
date: "09/02/2024"
output:
  html_document:
    toc: yes
    toc_depth: '4'
    df_print: paged
  bookdown::html_document2:
    toc: no
    toc_float: yes
    toc_depth: 4
    number_sections: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.duplicate.label = 'allow')
```

### Loading necessary packages

```{r, libraries, include = FALSE}
library(tidybayes)
library(ggplot2)
library(dplyr)
library(tidyr)
library(rjags)
library(R2jags)
library(brms)
```

Loading the two Rdata containing the PISA data for the European countries. This data is saved as Europe_Pisamaths.Rdata in the folder called PISA_Data.

```{r loading the data}
load(here::here("PISA_Data", "Europe_Pisamaths.Rdata"))

#Filtering the data for 2022 since we have decided to make predictions with the models for year 2022.
PISA_Europe_Data <- Pisa_Europe_Data |>
  filter(year != "2022")
```

**We have 202 observations for this analysis**

### Creating the index for the variables in the data set.

```{r}
#Creating the indexes for the hierarchical variables.
country_names <- levels(factor(PISA_Europe_Data$Country))
region_names <- levels(factor(PISA_Europe_Data$Region))
income_names <- levels(factor(PISA_Europe_Data$Income))
incomeregion_names <- levels(factor(PISA_Europe_Data$Income_Region))

## Obtaining the region indexes

country_region <- PISA_Europe_Data |> group_by(Country) |>
  summarise(Region=first(Region)) |>
  mutate(Country_num = as.numeric(as.factor(Country))) |>
  mutate(region_num = as.numeric(as.factor(Region)))

REGION <- country_region |> select(Country, Region)

## Obtaining the income indexes

country_income <- PISA_Europe_Data |> group_by(Country) |>
  summarise(Income=first(Income)) |>
  mutate(Country_num = as.numeric(as.factor(Country))) |>
  mutate(income_num = as.numeric(as.factor(Income)))
         
INCOME <- country_income |> select(Country, Income)

## Obtaining the income_region indexes

country_incomeregion <- PISA_Europe_Data |> group_by(Country) |>
  summarise(Income_Region=first(Income_Region)) |>
  mutate(Country_num = as.numeric(as.factor(Country))) |>
  mutate(incomeregion_num = as.numeric(as.factor(Income_Region)))
         
INCOME_REGION <- REGION |>
  left_join(INCOME, join_by(Country))

Country_region <- country_region |> left_join(INCOME, join_by(Country))
Country_income <- country_income |> left_join(REGION, join_by(Country))
Country_incomeregion <- country_incomeregion |> left_join(INCOME_REGION, join_by(Country))
```

**We have decided to use BRMS for this analysis and include the JAGS Model as appendix**

## Setting the model specification in BRMS

### Writing BRMS model for country-level specifications


### Specifying the models in BRMS

## BRMS Model

BRMS Stuffs

```{r}
#library(cmdstanr)
options(mc.cores = 4
    #brms.backend = "cmdstanr"
)

bayes_seed <-1234
```

#### Independent model with gloabl mean as the slope.

```{r}
if (file.exists(here::here("Manuscript_Models", "CountryInd_BRMSModel.Rdata"))){
  load(here::here("Manuscript_Models", "CountryInd_BRMSModel.Rdata"))
  genBRMS <- FALSE
} else genBRMS <- TRUE

```

```{r, message=FALSE, eval= genBRMS}

Priors <- c(brms::prior(normal(500, 100), class = Intercept),
            brms::prior(normal(0, 5), class = b),
            brms::prior(cauchy(30, 10), class = sigma))


CountryInd_BRMSModel <- brms::brm(
  brms::bf(math ~ (year_orig*Country)),
  data = PISA_Europe_Data,
  iter = 10000, 
  prior = Priors,
  control = list(adapt_delta = 0.93),
  chains = 4, seed = bayes_seed)
```


#### Extracting the model estimates

```{r}
CountryInd_BRMSModel$fit

#The code above shows that the country off-sets were named as b_CountryCountryname e.g the offset for Albania is stored as b_CountryAlbania (these made it difficult to use our existing spread_rvars approach of pulling the estimates alongside the credible estimates as seen in the result pulling for model Country_BRMSModel). 

I resolved to;
fixef(CountryInd_BRMSModel)

#I know you have preference regarding the model estimates pulling, that's why I am reaching out.
```

#### Country-specific model with a distribution on all the country.

```{r, message=FALSE, eval= genBRMS}

Priors <- c(brms::prior(normal(500, 100), class = Intercept),
            brms::prior(normal(0, 5), class = b),
            brms::prior(cauchy(30, 10), class = sigma),
            brms::prior(cauchy(30, 10), class = sd, coef = Intercept, group=Country),
            brms::prior(cauchy(0, 2), class = sd, coef = year_orig, group=Country))


Country_BRMSModel <- brms::brm(
  brms::bf(math ~ year_orig + (1 + year_orig|Country)),
  data = PISA_Europe_Data,
  iter = 10000, 
  prior = Priors,
  control = list(adapt_delta = 0.93),
  chains = 4, seed = bayes_seed)
```

##### Extracting the estimates from this country-specific model

```{r}
## Pulling the intercept results. The global intercept (b_Intercept) and the country offsets.
Country_brmsI <- spread_rvars(Country_BRMSModel, r_Country[Country,term], b_Intercept) |>
  filter(term == "Intercept") |>
  mutate(Country = stringr::str_replace_all(Country, fixed("."), " ")) |>
  mutate(r_Country = r_Country+ b_Intercept) |>
  left_join(Country_region, join_by(Country== Country))|>
  select(Country,Region, Income, term, rvar=r_Country)

## Pulling the slope results. The global slope (b_year_orig) and the country offsets.
Country_brmsS <- spread_rvars(Country_BRMSModel, r_Country[Country,term], b_year_orig) |>
  filter(term == "year_orig") |>
  mutate(Country = stringr::str_replace_all(Country, fixed("."), " ")) |>
  mutate(r_Country = r_Country+ b_year_orig) |>
  left_join(Country_region, join_by(Country== Country))|>
  select(Country,Region, Income, term, rvar=r_Country)

## Tidying the estimates
Country_brmsIS <- rbind(Country_brmsI, Country_brmsS)

Country_brmsIS_Est <- Country_brmsIS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term)

## Credible interval
## Intercept Estimates
Country_Int_BRMS_Est <- Country_brmsI |> median_qi(rvar) |>
  select(c(Country,Region, Income,rvar, .lower, .upper))

## Slope Estimates
Country_Slop_BRMS_Est <- Country_brmsS |> median_qi(rvar) |>
  select(c(Country,Region, Income,rvar, .lower, .upper))
```

